<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR QR Gallery - Camera Debug</title>
    <link rel="stylesheet" href="./css/style.css" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
    <style>
      /* Force video to be visible for debugging */
      video {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1 !important;
        background: red !important;
      }
      canvas {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 2 !important;
      }
      #status {
        position: fixed !important;
        top: 10px !important;
        left: 10px !important;
        z-index: 1000 !important;
        background: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        padding: 10px !important;
        font-family: monospace !important;
        font-size: 12px !important;
        max-width: 300px !important;
      }
    </style>
  </head>
  <body>
    <div id="status">Checking camera...</div>

    <a-scene
      embedded
      mindar-image="imageTargetSrc: ./ar/paramo/target.mind; autoStart: true; showStats: false;"
      color-space="sRGB"
      renderer="colorManagement: true; physicallyCorrectLights: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      id="arScene"
      style="position: fixed; top: 0; left: 0; width: 100%; height: 100%"
    >
      <a-entity mindar-image-target="targetIndex: 0" id="targetRoot">
        <a-box position="0 0 0" color="red" scale="0.1 0.1 0.1"></a-box>
      </a-entity>
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    </a-scene>

    <script>
      const status = document.getElementById("status");

      function updateStatus(message) {
        console.log("[Camera Debug] " + message);
        status.innerHTML += "<br>" + message;
        status.scrollTop = status.scrollHeight;
      }

      updateStatus("Starting camera debug...");

      // Test camera directly
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          updateStatus("‚úÖ Camera stream obtained!");
          updateStatus(`Stream active: ${stream.active}`);
          updateStatus(`Video tracks: ${stream.getVideoTracks().length}`);

          // Create a visible video element for testing
          const testVideo = document.createElement("video");
          testVideo.srcObject = stream;
          testVideo.autoplay = true;
          testVideo.playsInline = true;
          testVideo.muted = true;
          testVideo.style.position = "fixed";
          testVideo.style.top = "50px";
          testVideo.style.right = "10px";
          testVideo.style.width = "200px";
          testVideo.style.height = "150px";
          testVideo.style.zIndex = "1001";
          testVideo.style.border = "2px solid lime";
          testVideo.style.background = "blue";
          document.body.appendChild(testVideo);

          testVideo.addEventListener("loadedmetadata", () => {
            updateStatus(
              `‚úÖ Test video loaded: ${testVideo.videoWidth}x${testVideo.videoHeight}`
            );
          });

          // Don't stop the stream - let MindAR use it
          // stream.getTracks().forEach(track => track.stop());
        })
        .catch((err) => {
          updateStatus("‚ùå Camera access failed: " + err.message);
        });

      // Monitor A-Frame scene
      document.addEventListener("DOMContentLoaded", () => {
        const scene = document.getElementById("arScene");

        scene.addEventListener("arReady", () => {
          updateStatus("üéâ AR Ready!");

          // Check for video elements
          setTimeout(() => {
            const videos = document.querySelectorAll("video");
            updateStatus(`Found ${videos.length} video element(s)`);

            videos.forEach((video, i) => {
              updateStatus(
                `Video ${i}: ${video.videoWidth}x${
                  video.videoHeight
                }, playing: ${!video.paused}`
              );

              // Force video to be visible
              video.style.display = "block !important";
              video.style.visibility = "visible !important";
              video.style.opacity = "1 !important";
            });

            const canvases = document.querySelectorAll("canvas");
            updateStatus(`Found ${canvases.length} canvas element(s)`);
          }, 2000);
        });

        scene.addEventListener("arError", (e) => {
          updateStatus("‚ùå AR Error: " + JSON.stringify(e.detail));
        });
      });
    </script>
  </body>
</html>
