<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Startup Debug</title>
    <style>
      body {
        font-family: system-ui;
        margin: 20px;
        background: #1a1a1a;
        color: white;
      }
      .log {
        background: #2a2a2a;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
        font-size: 11px;
      }
      button {
        padding: 12px 24px;
        margin: 10px;
        background: #007acc;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .error {
        color: #ff6b6b;
      }
      .success {
        color: #51cf66;
      }
      .warning {
        color: #ffd43b;
      }
      iframe {
        width: 100%;
        height: 400px;
        border: 1px solid #333;
        background: white;
      }
    </style>
  </head>
  <body>
    <h1>App Startup Debug</h1>

    <button onclick="loadMainApp()">Load Main App</button>
    <button onclick="testSystemStart()">Test System.start()</button>
    <button onclick="clearLog()">Clear Log</button>

    <div id="log" class="log">
      Click "Load Main App" to test the actual application...
    </div>

    <iframe id="appFrame" style="display: none"></iframe>

    <script>
      const log = document.getElementById("log");
      const appFrame = document.getElementById("appFrame");

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "error"
            ? "error"
            : type === "success"
            ? "success"
            : type === "warning"
            ? "warning"
            : "";
        const prefix =
          type === "error"
            ? "âŒ"
            : type === "success"
            ? "âœ…"
            : type === "warning"
            ? "âš ï¸"
            : "ðŸ“‹";

        const span = document.createElement("span");
        span.className = className;
        span.textContent = `[${timestamp}] ${prefix} ${message}\n`;

        log.appendChild(span);
        console.log(`[${type}] ${message}`);
        log.scrollTop = log.scrollHeight;
      }

      function clearLog() {
        log.innerHTML = "";
        addLog("Log cleared");
      }

      function loadMainApp() {
        addLog("=== Loading Main App in Frame ===");

        appFrame.style.display = "block";
        appFrame.src = "/ar/paramo";

        addLog("Loading /ar/paramo in iframe...");

        appFrame.onload = () => {
          addLog("Main app iframe loaded", "success");

          // Try to access the iframe's content for debugging
          setTimeout(() => {
            try {
              const iframeDoc =
                appFrame.contentDocument || appFrame.contentWindow.document;
              const sceneEl = iframeDoc.querySelector("a-scene");

              if (sceneEl) {
                addLog("A-Frame scene found in main app", "success");

                if (sceneEl.systems && sceneEl.systems["mindar-image-system"]) {
                  addLog("MindAR system found in main app", "success");
                  debugMainAppSystem(sceneEl.systems["mindar-image-system"]);
                } else {
                  addLog("MindAR system NOT found in main app", "error");
                }

                if (sceneEl.components && sceneEl.components["mindar-image"]) {
                  addLog("MindAR component found in main app", "success");
                } else {
                  addLog("MindAR component NOT found in main app", "error");
                }
              } else {
                addLog("No A-Frame scene found in main app", "error");
              }
            } catch (error) {
              addLog(
                `Cannot access iframe content: ${error.message}`,
                "warning"
              );
              addLog(
                "This is normal due to browser security. Check browser console instead."
              );
            }
          }, 3000);
        };

        appFrame.onerror = () => {
          addLog("Main app iframe failed to load", "error");
        };
      }

      function debugMainAppSystem(system) {
        addLog("=== Debugging Main App MindAR System ===");

        try {
          addLog(
            `System methods: ${Object.getOwnPropertyNames(system).join(", ")}`
          );

          if (typeof system.start === "function") {
            addLog("system.start() method exists", "success");
          } else {
            addLog("system.start() method MISSING", "error");
          }

          if (typeof system.setup === "function") {
            addLog("system.setup() method exists", "success");
          } else {
            addLog("system.setup() method missing", "warning");
          }
        } catch (error) {
          addLog(`Error debugging system: ${error.message}`, "error");
        }
      }

      async function testSystemStart() {
        addLog("=== Testing System Start Manually ===");

        // Create a test scene like the main app does
        const testContainer = document.createElement("div");
        testContainer.innerHTML = `
                <a-scene
                    embedded
                    mindar-image="autoStart: false; imageTargetSrc: /ar/paramo/target.mind"
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: false"
                    id="testScene"
                    style="width: 300px; height: 200px;"
                >
                    <a-entity mindar-image-target="targetIndex: 0" id="testTarget"></a-entity>
                    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
                </a-scene>
            `;

        document.body.appendChild(testContainer);

        const scene = document.getElementById("testScene");

        scene.addEventListener("loaded", async () => {
          addLog("Test scene loaded", "success");

          try {
            // Replicate the main app's startMindARScene logic
            const system = scene.systems
              ? scene.systems["mindar-image-system"]
              : null;

            if (system) {
              addLog("MindAR system found", "success");
              addLog(
                `System methods: ${Object.getOwnPropertyNames(system).join(
                  ", "
                )}`
              );

              if (typeof system.start === "function") {
                addLog("Calling system.start()...", "warning");
                await system.start();
                addLog("system.start() completed!", "success");
              } else {
                addLog("system.start() method not found", "error");
              }
            } else {
              addLog("MindAR system not found", "error");
            }
          } catch (error) {
            addLog(`system.start() failed: ${error.message}`, "error");
            addLog(`Error stack: ${error.stack}`);
          }

          // Clean up
          setTimeout(() => {
            testContainer.remove();
            addLog("Test scene cleaned up");
          }, 5000);
        });
      }

      addLog("App startup debug ready");
      addLog("This will help identify why the main app gets stuck at loading");
    </script>

    <script src="/libs/aframe.min.js"></script>
    <script src="/libs/mindar-image-aframe.prod.js"></script>
  </body>
</html>
