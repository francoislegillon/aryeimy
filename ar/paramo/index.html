<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no, shrink-to-fit=no"
    />
    <!-- Android-specific meta tags -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#000000" />
    <!-- Camera permissions hint -->
    <meta http-equiv="Permissions-Policy" content="camera=*" />
    <title>Paramo - AR Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe-master.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        /* Hardware acceleration for smoother performance */
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        /* Prevent text selection and touch interactions that could interfere */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
        /* Ensure full viewport coverage */
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }
      
      a-scene {
        /* Ensure scene covers full viewport */
        width: 100% !important;
        height: 100% !important;
      }
      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
      }
      .error {
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        background: #ff4444;
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
      }
      .hidden {
        display: none;
      }
      .footer {
        position: fixed;
        bottom: 10px;
        left: 10px;
        right: 10px;
        text-align: center;
        z-index: 999;
      }
      .footer a {
        color: white;
        text-decoration: none;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
      }
      .start-button {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #4caf50;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
      .start-button:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <div id="loading" class="loading">
      <h2>Loading Paramo...</h2>
      <p>Point your camera at the target image</p>
    </div>

    <button id="start-button" class="start-button">Start AR Experience</button>

    <div id="error" class="error hidden"></div>

    <a-scene
      id="ar-scene"
      mindar-image="imageTargetSrc: ./target.mind; autoStart: false; uiLoading: no; uiScanning: no; uiError: no"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      renderer="alpha: true; antialias: true; colorManagement: true; physicallyCorrectLights: true"
      style="position: fixed; top: 0; left: 0; width: 100%; height: 100%"
      embedded
    >
      <a-assets id="assets">
        <!-- Assets will be loaded dynamically -->
      </a-assets>

      <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>

      <a-entity
        id="target-root"
        mindar-image-target="targetIndex: 0"
      >
        <!-- AR content will be added here -->
      </a-entity>

      <a-camera 
        position="0 0 0" 
        look-controls="enabled: false" 
        cursor="rayOrigin: mouse"
        wasd-controls="enabled: false"
      ></a-camera>
    </a-scene>

    <div class="footer hidden" id="footer">
      <a href="" id="about-link" target="_blank">About this artwork</a>
    </div>

    <script>
      // Position smoothing variables
      let smoothingEnabled = true;
      let smoothingFactor = 0.95; // Much higher smoothing - more stable, less responsive
      let lastPositions = new Map();
      let lastRotations = new Map();
      let trackingConfidence = 0;
      let stableFrames = 0;
      let minStableFrames = 3;

      // Enhanced smoothing component for AR elements with position clamping
      AFRAME.registerComponent("smooth-tracking", {
        schema: {
          enabled: { type: "boolean", default: true },
          factor: { type: "number", default: 0.95 }, // Much higher smoothing
          threshold: { type: "number", default: 0.0005 }, // Lower threshold for tighter control
          maxDistance: { type: "number", default: 0.1 }, // Clamp sudden movements
        },

        init: function () {
          this.lastPos = new THREE.Vector3();
          this.lastRot = new THREE.Euler();
          this.targetPos = new THREE.Vector3();
          this.targetRot = new THREE.Euler();
          this.initialized = false;
          this.frameCount = 0;
        },

        tick: function () {
          if (!this.data.enabled) return;

          const el = this.el;
          const object3D = el.object3D;
          this.frameCount++;

          if (!this.initialized) {
            this.lastPos.copy(object3D.position);
            this.lastRot.copy(object3D.rotation);
            this.targetPos.copy(object3D.position);
            this.targetRot.copy(object3D.rotation);
            this.initialized = true;
            return;
          }

          // Get current tracking position
          const currentPos = object3D.position.clone();
          const currentRot = object3D.rotation.clone();

          // Clamp sudden movements to prevent jitter
          const distance = currentPos.distanceTo(this.lastPos);
          if (distance > this.data.maxDistance) {
            // If movement is too sudden, limit it
            const direction = currentPos.clone().sub(this.lastPos).normalize();
            currentPos
              .copy(this.lastPos)
              .add(direction.multiplyScalar(this.data.maxDistance));
          }

          // Smooth position with aggressive interpolation
          if (distance > this.data.threshold) {
            this.targetPos.lerp(currentPos, 1 - this.data.factor);
            object3D.position.copy(this.targetPos);
            this.lastPos.copy(this.targetPos);
          }

          // Smooth rotation with aggressive interpolation
          this.targetRot.x +=
            (currentRot.x - this.targetRot.x) * (1 - this.data.factor);
          this.targetRot.y +=
            (currentRot.y - this.targetRot.y) * (1 - this.data.factor);
          this.targetRot.z +=
            (currentRot.z - this.targetRot.z) * (1 - this.data.factor);
          object3D.rotation.copy(this.targetRot);
          this.lastRot.copy(this.targetRot);
        },
      });

      // Simple AR loader - reads manifest.json and creates AR experience
      async function loadARExperience() {
        try {
          console.log("ðŸš€ Starting AR experience...");

          // Load manifest
          const response = await fetch("./manifest.json");
          if (!response.ok) {
            throw new Error(`Failed to load manifest: ${response.status}`);
          }
          const manifest = await response.json();
          console.log("ðŸ“„ Loaded manifest:", manifest.title);

          // Update page title and about link
          document.title = `${manifest.title} - AR Experience`;
          if (manifest.aboutLink) {
            const aboutLink = document.getElementById("about-link");
            aboutLink.href = manifest.aboutLink;
            document.getElementById("footer").classList.remove("hidden");
          }

          // Get references
          const assetsEl = document.getElementById("assets");
          const targetRoot = document.getElementById("target-root");
          const loadingEl = document.getElementById("loading");
          const errorEl = document.getElementById("error");

          // Create assets and overlays
          manifest.overlays.forEach((overlay, index) => {
            try {
              // Create asset
              let assetEl;
              const assetId = `asset-${overlay.id}`;

              if (overlay.url.mp4) {
                // Video asset
                assetEl = document.createElement("video");
                assetEl.src = overlay.url.mp4;
                assetEl.setAttribute("autoplay", "true");
                assetEl.setAttribute("loop", "true");
                assetEl.setAttribute("muted", "true");
                assetEl.setAttribute("playsinline", "true");
                assetEl.setAttribute("crossorigin", "anonymous");
                assetEl.setAttribute("preload", "metadata"); // Changed from 'auto' to reduce memory
                // Performance optimizations to reduce jitter
                assetEl.setAttribute("webkit-playsinline", "true");
                assetEl.setAttribute("x-webkit-airplay", "allow");
                // Optimize video for tracking stability
                assetEl.style.webkitTransform = "translate3d(0,0,0)"; // Force GPU acceleration
                assetEl.style.transform = "translate3d(0,0,0)";
                assetEl.style.webkitBackfaceVisibility = "hidden";
                assetEl.style.backfaceVisibility = "hidden";
                // Reduce video quality for better performance if needed
                assetEl.setAttribute("poster", ""); // No poster image to reduce load

                // Add video event listeners for debugging and optimization
                assetEl.addEventListener("loadedmetadata", () => {
                  console.log(`ðŸ“¹ Video metadata loaded: ${overlay.id}`);
                  // Set video to lowest quality for better performance
                  if (assetEl.videoTracks && assetEl.videoTracks.length > 0) {
                    console.log(
                      `ðŸŽ¬ Video track info:`,
                      assetEl.videoWidth,
                      "x",
                      assetEl.videoHeight
                    );
                  }
                });
                assetEl.addEventListener("loadeddata", () => {
                  console.log(`âœ… Video loaded successfully: ${overlay.id}`);
                });
                assetEl.addEventListener("canplay", () => {
                  console.log(`ðŸŽ¬ Video can start playing: ${overlay.id}`);
                  // Explicitly play the video when it's ready
                  assetEl
                    .play()
                    .then(() => {
                      console.log(`â–¶ï¸ Video playing: ${overlay.id}`);
                    })
                    .catch((error) => {
                      console.warn(
                        `âš ï¸ Video autoplay prevented: ${overlay.id}`,
                        error
                      );
                    });
                });
                assetEl.addEventListener("error", (e) => {
                  console.error(`âŒ Video error for ${overlay.id}:`, e);
                });
                assetEl.addEventListener("stalled", () => {
                  console.warn(`âš ï¸ Video stalled: ${overlay.id}`);
                });
              } else {
                // Image asset (supports png, jpg, gif, webp)
                assetEl = document.createElement("img");
                const imageUrl =
                  overlay.url.png ||
                  overlay.url.jpg ||
                  overlay.url.gif ||
                  overlay.url.webp;
                if (!imageUrl) {
                  console.warn(
                    `âš ï¸ No supported image format for overlay: ${overlay.id}`
                  );
                  return;
                }
                assetEl.src = imageUrl;
                assetEl.setAttribute("crossorigin", "anonymous");
              }

              assetEl.id = assetId;
              assetsEl.appendChild(assetEl);

              // Create AR element
              const mediaEl = document.createElement(
                overlay.url.mp4 ? "a-video" : "a-image"
              );
              mediaEl.setAttribute("id", overlay.id);
              mediaEl.setAttribute("src", `#${assetId}`);
              mediaEl.setAttribute("position", overlay.position.join(" "));
              mediaEl.setAttribute("scale", overlay.scale.join(" "));

              if (overlay.url.mp4) {
                // Video-specific material setup
                mediaEl.setAttribute(
                  "material",
                  `transparent: true; opacity: ${overlay.opacity || 1.0}`
                );
                mediaEl.setAttribute("geometry", "primitive: plane");
                mediaEl.setAttribute("autoplay", "true");
                mediaEl.setAttribute("loop", "true");
              } else {
                // Image material setup
                mediaEl.setAttribute(
                  "material",
                  `transparent: true; opacity: ${overlay.opacity || 1.0}`
                );
              }

              targetRoot.appendChild(mediaEl);
              console.log(`âœ… Added overlay: ${overlay.id}`);
            } catch (error) {
              console.error(
                `âŒ Failed to create overlay ${overlay.id}:`,
                error
              );
            }
          });

          // Wait a moment for A-Frame to initialize
          setTimeout(() => {
            loadingEl.classList.add("hidden");
            console.log("âœ… AR experience ready!");

            // Ensure all videos are playing
            const videos = document.querySelectorAll("video");
            videos.forEach((video) => {
              if (video.paused) {
                video
                  .play()
                  .then(() => {
                    console.log("ðŸ”„ Started paused video:", video.id);
                  })
                  .catch((error) => {
                    console.warn("âš ï¸ Could not start video:", video.id, error);
                  });
              }
            });
          }, 1000);
        } catch (error) {
          console.error("âŒ Failed to load AR experience:", error);
          document.getElementById("loading").classList.add("hidden");
          const errorEl = document.getElementById("error");
          errorEl.textContent = `Error: ${error.message}`;
          errorEl.classList.remove("hidden");
        }
      }

      // Start AR function with Android compatibility
      async function startAR() {
        try {
          console.log("ðŸ¤– Starting AR for Android...");

          // Hide start button, show loading
          document.getElementById("start-button").style.display = "none";
          document.getElementById("loading").classList.remove("hidden");

          // Check camera permissions
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
              // Request camera permission explicitly
              const stream = await navigator.mediaDevices.getUserMedia({
                video: true,
              });
              console.log("ðŸ“¹ Camera permission granted");
              // Stop the stream immediately, MindAR will handle it
              stream.getTracks().forEach((track) => track.stop());
            } catch (permError) {
              throw new Error(
                "Camera permission denied. Please enable camera access and refresh."
              );
            }
          }

          // Start MindAR
          const arSystem =
            document.querySelector("a-scene").systems["mindar-image-system"];
          if (arSystem) {
            await arSystem.start();
            console.log("ðŸŽ¯ MindAR started successfully");
          }

          // Load AR content
          await loadARExperience();
        } catch (error) {
          console.error("âŒ Failed to start AR:", error);
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("start-button").style.display = "block";
          const errorEl = document.getElementById("error");
          errorEl.textContent = `Error: ${error.message}`;
          errorEl.classList.remove("hidden");
        }
      }

      // Start when page loads
      document.addEventListener("DOMContentLoaded", () => {
        console.log("ðŸ“± DOM loaded, setting up start button...");
        document
          .getElementById("start-button")
          .addEventListener("click", startAR);
      });
    </script>
  </body>
</html>
