<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindAR Isolation Test</title>
    <style>
      body {
        font-family: system-ui;
        margin: 20px;
        background: #1a1a1a;
        color: white;
      }
      .log {
        background: #2a2a2a;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
        font-size: 12px;
      }
      button {
        padding: 12px 24px;
        margin: 10px;
        background: #007acc;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .error {
        color: #ff6b6b;
      }
      .success {
        color: #51cf66;
      }
      .warning {
        color: #ffd43b;
      }
    </style>
  </head>
  <body>
    <h1>MindAR Isolation Test</h1>

    <button onclick="testTargetFile()">1. Test Target File</button>
    <button onclick="testAFrameBasic()">2. Test A-Frame Basic</button>
    <button onclick="testMindARComponent()">3. Test MindAR Component</button>
    <button onclick="testMindARMinimal()">4. Test MindAR Minimal</button>
    <button onclick="clearLog()">Clear Log</button>

    <div id="log" class="log">
      Click buttons in order to isolate the issue...
    </div>

    <div
      id="testContainer"
      style="
        width: 400px;
        height: 300px;
        border: 1px solid #333;
        margin: 20px 0;
      "
    >
      <!-- Test content will go here -->
    </div>

    <script src="/libs/aframe.min.js"></script>
    <script src="/libs/mindar-image-aframe.prod.js"></script>

    <script>
      const log = document.getElementById("log");
      const container = document.getElementById("testContainer");

      function addLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "error"
            ? "error"
            : type === "success"
            ? "success"
            : type === "warning"
            ? "warning"
            : "";
        const prefix =
          type === "error"
            ? "‚ùå"
            : type === "success"
            ? "‚úÖ"
            : type === "warning"
            ? "‚ö†Ô∏è"
            : "üìã";

        const span = document.createElement("span");
        span.className = className;
        span.textContent = `[${timestamp}] ${prefix} ${message}\n`;

        log.appendChild(span);
        console.log(`[${type}] ${message}`);
        log.scrollTop = log.scrollHeight;
      }

      function clearLog() {
        log.innerHTML = "";
        addLog("Log cleared");
      }

      // Test 1: Check if target file exists and is valid
      async function testTargetFile() {
        addLog("=== Testing Target File ===");

        try {
          addLog("Fetching /ar/paramo/target.mind...");
          const response = await fetch("/ar/paramo/target.mind");

          if (!response.ok) {
            addLog(`Target file fetch failed: ${response.status}`, "error");
            return;
          }

          const contentType = response.headers.get("content-type");
          addLog(`Content-Type: ${contentType || "unknown"}`);

          const arrayBuffer = await response.arrayBuffer();
          addLog(
            `Target file size: ${arrayBuffer.byteLength} bytes`,
            "success"
          );

          if (arrayBuffer.byteLength < 100) {
            addLog(
              "Target file seems too small - might be placeholder text",
              "warning"
            );
          } else {
            addLog("Target file size looks reasonable", "success");
          }

          // Check first few bytes
          const bytes = new Uint8Array(arrayBuffer.slice(0, 20));
          const hexString = Array.from(bytes)
            .map((b) => b.toString(16).padStart(2, "0"))
            .join(" ");
          addLog(`First 20 bytes: ${hexString}`);
        } catch (error) {
          addLog(`Target file test failed: ${error.message}`, "error");
        }
      }

      // Test 2: Basic A-Frame scene
      async function testAFrameBasic() {
        addLog("=== Testing Basic A-Frame ===");

        try {
          if (!window.AFRAME) {
            addLog("A-Frame not loaded", "error");
            return;
          }
          addLog(`A-Frame version: ${AFRAME.version}`, "success");

          addLog("Creating basic A-Frame scene...");
          container.innerHTML = `
                    <a-scene embedded style="width: 100%; height: 100%;" id="basicScene">
                        <a-box position="0 0 -5" material="color: red;"></a-box>
                        <a-camera></a-camera>
                    </a-scene>
                `;

          const scene = document.getElementById("basicScene");
          scene.addEventListener("loaded", () => {
            addLog("Basic A-Frame scene loaded successfully", "success");
          });

          setTimeout(() => {
            if (!scene.hasLoaded) {
              addLog("A-Frame scene taking too long to load", "warning");
            }
          }, 3000);
        } catch (error) {
          addLog(`A-Frame basic test failed: ${error.message}`, "error");
        }
      }

      // Test 3: Check MindAR component
      async function testMindARComponent() {
        addLog("=== Testing MindAR Component ===");

        try {
          if (!window.AFRAME) {
            addLog("A-Frame not loaded", "error");
            return;
          }

          if (!AFRAME.components["mindar-image"]) {
            addLog("MindAR component not registered", "error");
            return;
          }
          addLog("MindAR component found", "success");

          const component = AFRAME.components["mindar-image"];
          addLog(
            `Component schema keys: ${Object.keys(component.schema).join(", ")}`
          );

          if (!AFRAME.systems["mindar-image-system"]) {
            addLog("MindAR system not registered", "error");
            return;
          }
          addLog("MindAR system found", "success");
        } catch (error) {
          addLog(`MindAR component test failed: ${error.message}`, "error");
        }
      }

      // Test 4: Minimal MindAR scene without autoStart
      async function testMindARMinimal() {
        addLog("=== Testing Minimal MindAR Scene ===");

        try {
          addLog("Creating minimal MindAR scene...");
          container.innerHTML = `
                    <a-scene
                        embedded
                        style="width: 100%; height: 100%;"
                        id="mindArScene"
                        mindar-image="autoStart: false; imageTargetSrc: /ar/paramo/target.mind"
                        vr-mode-ui="enabled: false"
                    >
                        <a-entity mindar-image-target="targetIndex: 0" id="target">
                            <a-text value="Hello AR" position="0 0 0" color="red"></a-text>
                        </a-entity>
                        <a-camera position="0 0 0"></a-camera>
                    </a-scene>
                `;

          const scene = document.getElementById("mindArScene");

          // Set up comprehensive event listeners
          scene.addEventListener("loaded", () => {
            addLog("MindAR scene loaded", "success");
            setTimeout(() => {
              testMindARManualStart();
            }, 1000);
          });

          scene.addEventListener("arReady", () => {
            addLog("MindAR ready event fired!", "success");
          });

          scene.addEventListener("arError", (e) => {
            addLog(`MindAR error: ${JSON.stringify(e.detail)}`, "error");
          });

          // Additional MindAR events
          scene.addEventListener("targetFound", () => {
            addLog("Target found!", "success");
          });

          scene.addEventListener("targetLost", () => {
            addLog("Target lost", "warning");
          });

          setTimeout(() => {
            if (!scene.hasLoaded) {
              addLog("MindAR scene failed to load within 5 seconds", "error");
              debugSceneComponents();
            }
          }, 5000);
        } catch (error) {
          addLog(`MindAR minimal test failed: ${error.message}`, "error");
        }
      }

      async function testMindARManualStart() {
        addLog("=== Attempting Manual MindAR Start ===");

        try {
          const scene = document.getElementById("mindArScene");
          if (!scene) {
            addLog("Scene not found", "error");
            return;
          }

          const system = scene.systems["mindar-image-system"];
          if (!system) {
            addLog("MindAR system not found", "error");
            return;
          }
          addLog("MindAR system found", "success");

          const component = scene.components["mindar-image"];
          if (!component) {
            addLog("MindAR component not found", "error");
            return;
          }
          addLog("MindAR component found", "success");

          addLog("Attempting to start MindAR manually...");

          // Try system start first
          if (typeof system.start === "function") {
            addLog("Calling system.start()...");
            system.start();
          } else {
            addLog("system.start() not available", "warning");
          }

          // Wait a bit then check status
          setTimeout(() => {
            const video = document.querySelector("video");
            if (video) {
              addLog(
                `Video element created: ${video.videoWidth}x${video.videoHeight}`,
                "success"
              );
            } else {
              addLog("No video element found - camera not started", "error");
            }
          }, 2000);
        } catch (error) {
          addLog(`Manual start failed: ${error.message}`, "error");
        }
      }

      function debugSceneComponents() {
        addLog("=== Debugging Scene Components ===");

        const scene = document.getElementById("mindArScene");
        if (!scene) return;

        addLog(`Scene hasLoaded: ${scene.hasLoaded}`);
        addLog(
          `Scene components: ${Object.keys(scene.components || {}).join(", ")}`
        );
        addLog(`Scene systems: ${Object.keys(scene.systems || {}).join(", ")}`);

        const errors = scene.querySelectorAll("[error]");
        if (errors.length > 0) {
          addLog(`Found ${errors.length} elements with errors`, "error");
        }
      }

      addLog("MindAR isolation test ready");
      addLog("Run tests in order: 1 ‚Üí 2 ‚Üí 3 ‚Üí 4");
    </script>
  </body>
</html>
